purge

tic

chord = 0.3215;
wingspan = 1.02;
nchordpanels = 1;
nspanpanels = 2; %This effects L0 when far away

%%%%%%%%CHILD WING LOCATION%%%%%%%%%%%%%%%
%%%ASSUME THAT WING PROPERTIES ARE THE SAME%%

NAC = 2;
xcgparent = 0;
ycgparent = 0;

xrootparent = chord/2;
yrootparent = 0;

xcgchild = 1000;
ycgchild = 1000;

xrootchild = chord/2;
yrootchild = -wingspan;

xlocation = -(xcgchild + xrootchild - xcgparent - xrootparent)
ylocation = ycgchild + yrootchild - ycgparent - yrootparent

%%%%%%%%%%%%%%STEP 1 Break Wing Into Panel Sections%%%%%%%%%%

Sarea = wingspan*chord;
nspan = nspanpanels;
nchord = nchordpanels;
ntotal = nspan*nchord;
dxpanel = chord/nchord;
dypanel = (wingspan)/nspan;
l = dxpanel;

%%%MOTHERSHIP
CONTROLPOINTS = zeros(nspan*nchord,2);
counter = 0;
for ii = 1:nchord
  chordloc = (ii-1)*dxpanel + 3*l/4;
  for jj = 1:nspan
    counter = counter+1;
    spanloc = (jj-1)*dypanel + dypanel/2;
    CONTROLPOINTS(counter,:) = [chordloc,spanloc];
  end
end
%%CHILD
CONTROLPOINTSCHILD = zeros(nspan*nchord,2);
counter = 0;
for ii = 1:nchord
  chordloc = (ii-1)*dxpanel + 3*l/4+xlocation;
  for jj = 1:nspan
    counter = counter+1;
    spanloc = (jj-1)*dypanel + dypanel/2+ylocation;
    CONTROLPOINTSCHILD(counter,:) = [chordloc,spanloc];
  end
end

%%%%%%%%%%%%MOTHERSHIP%%%%%%%%%%%%%%%%%%%%%%%%%%
VORTEXA = 0.*CONTROLPOINTS;
VORTEXB = 0.*CONTROLPOINTS;
counter = 0;
for ii = 1:nchord
  chordloc = (ii-1)*dxpanel + l/4;
  for jj = 1:nspan
    counter = counter + 1;
    spana = (jj-1)*dypanel;
    spanb = (jj)*dypanel;
    VORTEXA(counter,:) = [chordloc,spana];
    VORTEXB(counter,:) = [chordloc,spanb];
  end
end
%%%%%%%%%%%%%%CHILD%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
VORTEXACHILD = 0.*CONTROLPOINTSCHILD;
VORTEXBCHILD = 0.*CONTROLPOINTSCHILD;
counter = 0;
for ii = 1:nchord
  chordloc = (ii-1)*dxpanel + l/4+xlocation;
  for jj = 1:nspan
    counter = counter + 1;
    spana = (jj-1)*dypanel+ylocation;
    spanb = (jj)*dypanel+ylocation;
    VORTEXACHILD(counter,:) = [chordloc,spana];
    VORTEXBCHILD(counter,:) = [chordloc,spanb];
  end
end

%%%%%%%%%%%%STEP 2,3 FIND THE DOWNWASH AT ALL CONTROL POINTS DUE TO
%%%%%%%%%%%%%EACH HORSHOE VORTEX%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%CONCATENATE CONTROLPOINTS AND VORTICES%%%%%%%%%%%%%%%%%
CONTROLPOINTS = [CONTROLPOINTS;CONTROLPOINTSCHILD];
VORTEXA = [VORTEXA;VORTEXACHILD];
VORTEXB = [VORTEXB;VORTEXBCHILD];

ntotal = ntotal*NAC;
C = zeros(ntotal,ntotal);
for ii = 1:ntotal
  %%ii = control point
  %%CONTROLPOINTS(ii,:) -- x,y coordinate for control point
  for jj = 1:ntotal
    %%jj = horshoe vortex
    %%VORTEXA(jj,:) -- x,y coordinate for A point on vortex
    %%VORTEXB(jj,:) -- x,y coordinate for B point on vortex
    w = Horshoe(CONTROLPOINTS(ii,:),VORTEXA(jj,:),VORTEXB(jj,:));
    C(ii,jj) = w;
  end
end

%%%%%%%%STEP 4 SOLVE SYSTEM OF EQUATIONS%%%%%%%%%%%%%%%%
%%%%WE NOW HAVE A SYSTEM OF EQUATIONS W=C*G%%%%%%%%%%%%%

w = -ones(ntotal,1);
g = inv(C)*w;

%%%%%%%%%%%%EXTRACT MOTHER AND CHILD%%%%%%%%%%%%%%%

gmothership = g(1:ntotal/2);
gchild = g(ntotal/2+1:end);

%%%%%%%%%%%%%%%%%%%%%%STEP 5 %%%%%%%%%%%%%%%%%%%%%
%%%%%%NOW WE CAN COMPUTE LIFT AND DRAG%%%%%%%%%%%%
Clam = 0;
Clac = 0;
for ii = 1:ntotal/2
  Clam = Clam - gmothership(ii);
  Clac = Clac - gchild(ii);
end
Clam
Clac
Claequivm = 2*Clam/Sarea
Claequivc = 2*Clac/Sarea

%%%%%%%STEP 6 ROLL MOMENT%%%%%%%%%%%%%%%
Clalm = 0;
Clalc = 0;
for ii = 1:ntotal/2
    dist = -1+2*(ii-1)/(ntotal/2-1);
    Clalm = Clalm + gmothership(ii)*dypanel*dist;
    Clalc = Clalc + gchild(ii)*dypanel*dist;
end
Clalm = 2*Clalm/(chord*Sarea)
Clalc = 2*Clalc/(chord*Sarea)

%%Now normalize
N = 3.4235;
fM = Claequivm/N
fC = Claequivc/N
lM = Clalm
lC = Clalc
toc